<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="csxt.lwm.dao.ReleaseCargoDao">
    <!--查询所有的供应商档案信息-->
    <select id="selectAllSupplierFile" resultType="csxt.entity.SupplierFile">
        select * from supplier_file
    </select>
    <!--根据供应商档案编号查询供应商档案信息-->
    <select id="selectSupplierFileById" parameterType="int" resultType="csxt.entity.SupplierFile">
        select * from supplier_file where id=#{id}
    </select>
    <!--查询供应商所有推荐的产品-->
    <select id="selectRecommendByDetail" parameterType="int" resultType="csxt.entity.DFile">
        SELECT * FROM D_FILE WHERE product_id IN (
            SELECT product_id FROM supplier_recommend WHERE id IN
                (SELECT recommend_id FROM supplier_recommend_detail WHERE supplier_id=#{supplierId})
        )
    </select>
    <!--查询这个供应商是否有产品正在放货-->
    <select id="selectWhetherBePut" parameterType="int" resultType="integer">
        SELECT sum_number FROM release_cargo
        WHERE buyer_plan_id=(
        SELECT id FROM buyer_execute WHERE product_id=#{productId} AND put_tag='F001-2'
        AND id IN (SELECT buyer_execute_id FROM buyer_execute_detail WHERE supplier_id=#{supplierId})
        )
    </select>
    <!--查询这个产品是否有执行单-->
    <select id="selectExecuteWhetherExist" parameterType="int" resultType="integer">
        SELECT SUM(amount) FROM buyer_execute_detail where
        buyer_execute_id in (select id from buyer_execute where product_id=#{productId} and check_tag='R001-1' and (put_tag='F001-0' or put_tag='F001-2'))
        AND supplier_id=#{supplierId}
    </select>
    <!--查询这个供应商需要登记的产品的执行单编号-->
    <select id="selectExecuteById" parameterType="int" resultType="int">
        SELECT buyer_execute_id FROM buyer_execute_detail where
        buyer_execute_id in (select id from buyer_execute where product_id=#{productId} and check_tag='R001-1' and (put_tag='F001-0' or put_tag='F001-2'))
        AND supplier_id=#{supplierId}
    </select>
    <!--新增放货登记并返回主键-->
    <insert id="insertReleaseCargo" parameterType="csxt.entity.ReleaseCargo" keyColumn="id" useGeneratedKeys="true" keyProperty="id">
        insert into release_cargo (id,buyer_plan_id,supplier_id,suppselectExecuteByIderNumber},#{buyer},#{releasePerson},#{returns},#{returnTime},#{sumNumber},#{sumMoney},null,null,#{register},#{registerTime},#{comment},null,null,'R001-0','D001-0','D001-0')
    </insert>
    <!--查询执行单编号-->
    <insert id="insertReleaseCargoDetails" parameterType="java.util.List">
        insert into release_cargo_detail (id,release_cargo_id,product_id,product_name,`DESCRIBE`,put_number,need_number,qualified_number,amount_unit,real_cost_price,put_subtotal,qualified_subtotal) values
        <foreach item="item" index="index" collection="list" separator=",">
            (null,#{item.releaseCargoId},#{item.productId},#{item.productName},#{item.describe},#{item.needNumber},#{item.needNumber},0,#{item.amountUnit},#{item.realCostPrice},#{item.putSubtotal},0)
        </foreach>
    </insert>
    <!--修改执行单的状态-->
    <update id="updateBuyerExecuteTag" parameterType="int">
        update buyer_execute set Execute_tag='E001-2',put_tag='F001-1' where id=#{buyerPlanId}
    </update>
    <!--修改执行单的状态-->
    <update id="updateBuyerExecuteTagUnequal" parameterType="int">
        update buyer_execute set Execute_tag='E001-2',put_tag='F001-2' where id=#{buyerPlanId}
    </update>
</mapper>